### **【情報共有】Next.js開発環境における問題調査の経緯と解決策**

現在開発中のNext.jsアプリケーション（ap-code-practice）において、開発環境（npm run dev）で断続的に発生した問題の調査経緯と暫定的な解決策を共有します。

#### **発生した問題の概要**

開発サーバー起動後、特定の操作を行うとNext.jsのFast Refreshが連続してフルリロードを実行したり、ビルドエラーやハイドレーションエラーが発生したりと、開発が困難になる事象が複数回発生しました。

#### **調査と解決の経緯**

以下に、発生した問題とそれに対する対応を時系列でまとめます。

**1\. 初期の無限リロード**

* **現象**: アプリケーション起動直後から無限リロードが発生。  
* **原因**: next.config.mjsに設定されていた実験的機能（特にtopLevelAwait: true）がFast Refreshと競合していました。  
* **対応**: asyncWebAssembly: true以外の実験的機能を無効化し、問題を解消しました。

**2\. /demo/problemsページでの無限リロード**

* **現象**: 問題データ表示ページへの遷移時に無限リロードが再発。  
* **原因**: 問題データ（JSONファイル）がpublicディレクトリ外に配置されていたため、fetchによる読み込みに失敗（404エラー）し、これがFast Refreshのトリガーとなっていました。  
* **対応**: プロジェクトルートにpublicディレクトリを作成し、その中にdataフォルダを移動させることで、ファイルが正常に読み込まれるように修正しました。

**3\. キャッシュ不整合による無限リロード**

* **現象**: 上記ファイル移動後、webpack.hot-update.jsonの404エラーを起因とする無限リロードが発生。  
* **原因**: ファイル構造の変更により、Next.jsのビルドキャッシュ（.nextフォルダ）に不整合が生じたと推測されます。  
* **対応**: .next、node\_modules、package-lock.jsonを完全に削除し、npm installで依存関係をクリーンな状態から再構築することで解消しました。

**4\. ビルドエラーの発生**

* **現象**: 依存関係の再インストール後、lucide-reactライブラリ内部でモジュールが見つからないというビルドエラーが発生。  
* **原因**: 再インストールしたlucide-reactのバージョンとプロジェクトの間に互換性の問題が発生した可能性があります。  
* **対応**: lucide-reactのバージョンを少し前の安定版（0.390.0）に固定してインストールし直すことで、ビルドが通るようになりました。

**5\. ハイドレーションエラーの発生**

* **現象**: ビルドは成功したものの、ブラウザ上でUIの不一致によるハイドレーションエラーが発生。  
* **原因**:  
  1. ThemeToggleコンポーネントが、クライアント側の準備が整う前にUIを描画しようとしていた。  
  2. pages/index.tsx内のパフォーマンス測定シミュレーション処理でMath.random()を使用していたため、ReactのStrict Mode（開発モードではuseEffectが2回実行される）によってサーバーとクライアントで異なるUIが生成されていました。  
* **対応**:  
  1. ThemeToggleがマウントされるまでnullを返すように修正。  
  2. useEffect内でのシミュレーション処理（measurePerformance()の呼び出し）をコメントアウトし、不要なランダム値の生成と状態更新を停止させたことでエラーを解消しました。

#### **まとめと今後の課題**

一連の問題は、**Next.jsのFast Refresh機能やサーバーサイドレンダリングの仕組みと、副作用（特に非同期処理、WASMモジュールの初期化、クライアント側でのみ利用可能なAPIの使用など）を持つコードとの相互作用**が主な原因であったと結論付けられます。

開発を本格的に進めるにあたり、以下の点についてより詳細な調査と恒久的な対策を検討する必要があると考えられます。

* **WASMライブラリの安定した初期化方法の確立**: Pyodideやsql.jsの初期化処理が、ReactのライフサイクルやNext.jsのレンダリングと干渉しない、より堅牢な実装方法を検討する。  
* **React Strict Modeへの完全対応**: 開発モードでuseEffectが2回実行されても問題が発生しない、副作用のないクリーンなコンポーネント設計を徹底する。  
* **サーバーとクライアントのレンダリングの一貫性**: サーバーとクライアントで実行結果が異なる可能性のある処理（例：new Date()、Math.random()、windowオブジェクトへのアクセスなど）をuseEffect内に正しく配置し、ハイドレーションエラーを防ぐ。

以上、ご査収ください。