\# 不具合報告書：穴埋め問題インタラクション

\#\# 1\. 件名  
【致命的】穴埋め問題の空欄クリックに反応せず、回答が不可能

\#\# 2\. 報告情報  
\- \*\*報告日\*\*: 2025年7月24日  
\- \*\*報告者\*\*: ユーザー  
\- \*\*発生バージョン\*\*: Phase 2-B-2 開発ブランチ  
\- \*\*重要度\*\*: 高（コア機能の利用不可）

\#\# 3\. 現象の概要  
応用情報技術者試験の問題ページ（\`/problems/:id\`）において、ユーザーが回答すべき擬似言語やSQLの\*\*空欄部分をクリックしても、選択肢が表示されず、一切の反応がない\*\*。これにより、ユーザーは問題を解き進めることができず、学習フローが完全に停止している。

\#\# 4\. 再現手順  
1\. アプリケーションを起動し、問題一覧ページ (\`/problems\`) にアクセスする。  
2\. 任意のアルゴリズム問題またはデータベース問題を選択し、「学習を開始」をクリックする。  
3\. 問題ページが表示され、左側に問題文とコードが表示されることを確認する。  
4\. コード内に表示されている \`\[ ア \]\` のような空欄部分をクリックする。

\#\# 5\. 期待される動作  
\- 空欄部分をクリックすると、その空欄に対応する選択肢がコードブロックの下に表示される。  
\- ユーザーは表示された選択肢から回答を選択できる。

\#\# 6\. 実際の動作  
\- 空欄部分をクリックしても、画面に一切の変化がなく、何も起こらない。  
\- 選択肢が表示されないため、回答プロセスに進むことができない。

\#\# 7\. 原因分析  
根本的な原因は、\`src/components/BlankFillEditor.tsx\` コンポーネント内の、\*\*空欄をインタラクティブな要素に置換するロジックの不備\*\*にあると推定される。

1\.  \*\*正規表現の不一致\*\*:  
    \`renderCodeWithBlanks\` 関数内で空欄を置換するために使用されている正規表現 \`new RegExp(\\\`\\\\\[${blankId}\\\\\]\\\`, 'g')\` は、角括弧 \`\[\]\` を想定している。しかし、実際の問題データ (\`r4s-q8.json\` など) では、全角の隅付き括弧 \`［］\` と全角スペース \`　\` が使用されている（例: \`［　ア　］\`）。このミスマッチにより、置換処理が失敗し、クリック可能な \`\<span\>\` 要素が生成されていない。

2\.  \*\*イベントハンドラの不備\*\*:  
    \`handleCodeClick\` イベントハンドラは、クリックされた要素が \`data-blank-id\` 属性を持つことを期待している。しかし、前述の置換失敗により、そもそもこの属性を持つ要素がDOMに存在しないため、クリックイベントが正しく処理されない。

\#\# 8\. 修正案  
\`src/components/BlankFillEditor.tsx\` の \`renderCodeWithBlanks\` 関数を以下のように修正することを提案する。

1\.  \*\*正規表現の修正\*\*:  
    問題データ (\`pseudoCode\` や \`queryTemplate\`) 内の空欄パターン \`［　ア　］\` に一致するよう、正規表現を修正する。

    \`\`\`typescript  
    // 修正前  
    codeWithBlanks \= codeWithBlanks.replace(new RegExp(\`\\\\\[${blankId}\\\\\]\`, 'g'), blankElement);

    // 修正後  
    const blankPattern \= new RegExp(\`［　${blank.id.replace('blank\_', '').toUpperCase()}　］\`, 'g');  
    codeWithBlanks \= codeWithBlanks.replace(blankPattern, blankElement);  
    \`\`\`

2\.  \*\*クリックイベントの確実な発火\*\*:  
    \`dangerouslySetInnerHTML\` を使用しているため、Reactのイベントシステムではなく、ネイティブのDOMイベントとして処理されている。現在の実装では親要素でイベントを拾っているが、これは意図通りに動作しているか再確認が必要。まずは正規表現の修正で置換が正しく行われることを確認することが最優先。

\#\# 9\. 添付資料  
ユーザーから提供されたスクリーンショットを参照。コード内の空欄がハイライトされておらず、インタラクティブな状態になっていないことが確認できる。

\!\[ユーザー提供のスクリーンショット\](https://storage.googleapis.com/claude-2-sandbox-user-data-prod/4b00570b-6031-4828-874e-53c20058b738.png)

\---  
以上  
